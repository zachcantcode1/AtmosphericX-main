<!DOCTYPE html>
<html>
    <title>AtmosphericX</title>
    <link rel="icon" href="/assets/media/dashboard/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../widgets/alert_bar@widget/index.css">
    <link rel="stylesheet" href="../../assets/styles/variables.css">
    <body>
        <div class="alert-bar-stream">
            <div class="alert-bar-header">
                <span id="event-name"></span>
            </div>
            <div class="alert-bar-details">
                <div class="alert-bar-section locations">
                    <span class="label">LOCATIONS:</span>
                    <span id="event-locations"></span>
                </div>
                <div class="alert-bar-section threats">
                    <span class="label">THREATS:</span>
                    <span id="event-threats"></span>
                </div>
                <div class="alert-bar-section source">
                    <span class="label">SOURCE:</span>
                    <span id="event-source"></span>
                </div>
            </div>
            <div id="alert-error" style="color:red; font-weight:bold; display:none; padding:0.5em 1em;"></div>
        </div>
    </body>
    <script src="../../assets/javascript/alerts.js"></script>
    <script src="../../assets/javascript/library.js"></script>
    <script>
        let library = new Library();
        library.createWebsocketSession([`public`, `active`, `manual`]).then(() => {
            let alert_class = new Alerts(library, true);
            library.detectMobileDevice();
            function updateAlertBar() {
                try {
                    let storage = alert_class.syncAlerts();
                    console.log('Alert storage:', storage);
                    if (!storage || storage.length === 0) {
                        document.getElementById('event-name').textContent = 'NO ACTIVE ALERT';
                        document.getElementById('event-locations').textContent = '';
                        document.getElementById('event-threats').textContent = '';
                        document.getElementById('event-source').textContent = '';
                        document.getElementById('alert-error').style.display = 'none';
                        return;
                    }
                    let alert = storage[0];
                    console.log('Most recent alert:', alert);
                    document.getElementById('event-name').textContent = (alert.event || 'UNKNOWN ALERT').toUpperCase();
                    let locations = Array.isArray(alert.locations) ? alert.locations.join(' â€¢ ') : (alert.locations || '');
                    document.getElementById('event-locations').textContent = locations.toUpperCase();
                    let threats = [];
                    if (alert.max_wind) threats.push(alert.max_wind);
                    if (alert.max_hail) threats.push(alert.max_hail);
                    if (alert.tornado) threats.push(alert.tornado);
                    if (alert.damage) threats.push(alert.damage);
                    document.getElementById('event-threats').textContent = (threats.join(' AND ') || (alert.threats || '')).toUpperCase();
                    document.getElementById('event-source').textContent = (alert.source || alert.sender || 'UNKNOWN').toUpperCase();
                    document.getElementById('alert-error').style.display = 'none';
                } catch (e) {
                    document.getElementById('alert-error').textContent = 'ALERT BAR ERROR: ' + e;
                    document.getElementById('alert-error').style.display = 'block';
                    console.error('ALERT BAR ERROR:', e);
                }
            }
            updateAlertBar();
            document.addEventListener('onCacheUpdate', updateAlertBar);
        });
    </script>
</html>